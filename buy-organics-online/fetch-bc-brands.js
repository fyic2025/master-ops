/**
 * Fetch all BigCommerce brands for SEO team
 * Outputs to JSON for import into Supabase seo_brands table
 */

const https = require('https');
const fs = require('fs');

const BC_STORE_HASH = 'hhhi';
const BC_ACCESS_TOKEN = 'a96rfpx8xvhkb23h7esqy3y1i0jynpt';

function apiRequest(path) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'api.bigcommerce.com',
            path: `/stores/${BC_STORE_HASH}${path}`,
            method: 'GET',
            headers: {
                'X-Auth-Token': BC_ACCESS_TOKEN,
                'Accept': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                if (res.statusCode >= 200 && res.statusCode < 300) {
                    resolve(JSON.parse(data));
                } else {
                    reject(new Error(`API Error ${res.statusCode}: ${data}`));
                }
            });
        });
        req.on('error', reject);
        req.end();
    });
}

async function fetchAllBrands() {
    console.log('Fetching BigCommerce brands...\n');

    const allBrands = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
        try {
            const response = await apiRequest(`/v3/catalog/brands?limit=250&page=${page}`);
            const brands = response.data || [];

            allBrands.push(...brands);
            console.log(`Page ${page}: ${brands.length} brands`);

            hasMore = brands.length === 250;
            page++;

            // Rate limiting
            await new Promise(r => setTimeout(r, 200));
        } catch (error) {
            console.error('Error fetching brands:', error.message);
            break;
        }
    }

    console.log(`\nTotal brands fetched: ${allBrands.length}`);

    // Transform for seo_brands table
    const seoBrands = allBrands.map(brand => ({
        bc_brand_id: brand.id,
        name: brand.name,
        slug: brand.custom_url?.url?.replace(/\//g, '') || brand.name.toLowerCase().replace(/\s+/g, '-'),
        url: brand.custom_url?.url || `/brands/${brand.name.toLowerCase().replace(/\s+/g, '-')}/`,
        description: null, // Will be generated by Brand Agent
        meta_title: brand.page_title || null,
        meta_description: brand.meta_description || null,
        image_url: brand.image_url || null,
        search_keywords: brand.search_keywords || null,
        content_status: 'unknown',
        product_count: 0 // Will be populated later
    }));

    // Save to file
    fs.writeFileSync('bc-brands.json', JSON.stringify(seoBrands, null, 2));
    console.log('\nâœ“ Saved to bc-brands.json');

    // Summary
    const withImages = seoBrands.filter(b => b.image_url);
    const withMeta = seoBrands.filter(b => b.meta_description);

    console.log('\nBrand Summary:');
    console.log(`  Total brands: ${seoBrands.length}`);
    console.log(`  With images: ${withImages.length}`);
    console.log(`  With meta description: ${withMeta.length}`);

    // Show first 20 brands
    console.log('\nSample brands:');
    seoBrands.slice(0, 20).forEach(brand => {
        console.log(`  ${brand.name}`);
    });
    if (seoBrands.length > 20) {
        console.log(`  ... and ${seoBrands.length - 20} more`);
    }

    return seoBrands;
}

fetchAllBrands().catch(console.error);
