---
brands:
---

{{#partial "page"}}

{{> components/common/breadcrumbs breadcrumbs=breadcrumbs}}

<main class="page">
    <h1 class="page-heading">{{lang 'brand.label'}}</h1>
    {{{region name="brands_below_header"}}}
    <div class="brand_search">
        <input id="brand_search" class="searchInput transition form-input" placeholder="Search Brand" value="" autocomplete="off">
        <ul id="brand_suggestions" class="brand-autocomplete"></ul>
    </div>
    <div class="filter_list">
        <div class="pagination">
            <ul class="pagination-list" id="filterID"></ul>
        </div>
        <div class="clr"></div>
    </div>
    {{!-- Brand grid starts empty - populated by JS to prevent loading all 360 images --}}
    <ul class="brandGrid" id="brandGridDisplay"></ul>

    {{!-- All brands data from shop_by_brand (not paginated, complete list) --}}
    {{!-- Images fetched via single GraphQL request for performance --}}
    <ul class="brand_list" id="brandDataSource" style="display:none !important;">
        {{#each shop_by_brand}}
        <li data-url="{{url}}" data-name="{{name}}">{{name}}</li>
        {{/each}}
    </ul>
    {{{region name="brands_below_content"}}}
</main>

<style type="text/css">
.brand_search {
    width: 300px;
    margin: 0 auto 40px;
    position: relative;
}
.brand-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    list-style: none;
    margin: 0;
    padding: 0;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
}
.brand-autocomplete.show { display: block; }
.brand-autocomplete li a {
    display: block;
    padding: 8px 12px;
    text-decoration: none;
    color: #333;
}
.brand-autocomplete li a:hover,
.brand-autocomplete li.active a {
    background: #f0f0f0;
}
.filter_list { text-align: center; }
.filter_list .pagination { float: none; }
.filter_list .pagination-link { border: 1px solid #CCC; width: 30px; }
.pagination-item .pagination-link:hover,
.pagination-item .pagination-link.active { background-color: #CCC; }
#brand_search {
    border: 1px solid #66a647 !important;
    border-radius: 50px !important;
    padding: 15px 20px;
    font-size: inherit;
    height: auto;
    width: 100%;
    box-sizing: border-box;
}
.brand .card-img-container::after { padding-bottom: 100%; }
#brandDataSource { position: absolute; left: -9999px; height: 0; overflow: hidden; }
</style>

<script type="text/javascript">
(function() {
    var defaultImage = '{{cdn "img/BrandDefault.gif"}}';
    var allBrands = [];
    var letters = {};
    var sortedLetters = [];
    var imageMap = {};

    // Extract ALL brands from shop_by_brand first (complete list)
    function extractBrandData() {
        var dataElements = document.querySelectorAll('#brandDataSource li');
        for (var j = 0; j < dataElements.length; j++) {
            var el = dataElements[j];
            var name = el.getAttribute('data-name') || '';
            var letter = name.charAt(0).toUpperCase();
            if (/[0-9]/.test(letter)) letter = '#';

            allBrands.push({
                name: name,
                url: el.getAttribute('data-url'),
                image: defaultImage,
                letter: letter
            });
            letters[letter] = true;
        }

        sortedLetters = Object.keys(letters).sort(function(a, b) {
            if (a === '#') return -1;
            if (b === '#') return 1;
            return a.localeCompare(b);
        });
    }

    // Fetch all brand images via GraphQL with pagination (~8 requests instead of 368)
    function fetchBrandImages(cursor) {
        var query = cursor
            ? 'query { site { brands(first: 50, after: "' + cursor + '") { pageInfo { hasNextPage endCursor } edges { node { name defaultImage { url(width: 190) } } } } } }'
            : 'query { site { brands(first: 50) { pageInfo { hasNextPage endCursor } edges { node { name defaultImage { url(width: 190) } } } } } }';

        fetch('/graphql', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer {{settings.storefront_api.token}}'
            },
            body: JSON.stringify({ query: query })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data && data.data && data.data.site && data.data.site.brands) {
                var brands = data.data.site.brands;
                var edges = brands.edges;

                // Add images to map
                for (var i = 0; i < edges.length; i++) {
                    var node = edges[i].node;
                    if (node.defaultImage && node.defaultImage.url) {
                        imageMap[node.name.toLowerCase()] = node.defaultImage.url;
                    }
                }

                // Update allBrands with fetched images so far
                for (var k = 0; k < allBrands.length; k++) {
                    var nameLower = allBrands[k].name.toLowerCase();
                    if (imageMap[nameLower]) {
                        allBrands[k].image = imageMap[nameLower];
                    }
                }

                // Re-render current letter with images
                var activeLink = document.querySelector('.filter_list a.pagination-link.active');
                if (activeLink) {
                    renderBrands(activeLink.getAttribute('data-filter'));
                }

                // Fetch next page if available
                if (brands.pageInfo && brands.pageInfo.hasNextPage && brands.pageInfo.endCursor) {
                    fetchBrandImages(brands.pageInfo.endCursor);
                }
            }
        })
        .catch(function(err) {
            console.log('GraphQL brand images fetch error:', err.message);
        });
    }

    function renderBrands(targetLetter) {
        var grid = document.getElementById('brandGridDisplay');
        grid.innerHTML = '';

        for (var m = 0; m < allBrands.length; m++) {
            var brand = allBrands[m];
            if (brand.letter === targetLetter) {
                var li = document.createElement('li');
                li.className = 'brand';
                li.innerHTML = '<article class="card">' +
                    '<figure class="card-figure">' +
                    '<a href="' + brand.url + '">' +
                    '<div class="card-img-container">' +
                    '<img class="card-image" src="' + brand.image + '" alt="' + brand.name + '" loading="lazy">' +
                    '</div>' +
                    '</a>' +
                    '</figure>' +
                    '<div class="card-body">' +
                    '<h4 class="card-title"><a href="' + brand.url + '">' + brand.name + '</a></h4>' +
                    '</div>' +
                    '</article>';
                grid.appendChild(li);
            }
        }
    }

    function initBrands() {
        extractBrandData();

        // Build letter filter
        var filterList = document.getElementById('filterID');
        for (var k = 0; k < sortedLetters.length; k++) {
            var letter = sortedLetters[k];
            var activeClass = (k === 0) ? ' active' : '';
            var li = document.createElement('li');
            li.className = 'pagination-item' + activeClass;
            li.innerHTML = '<a class="pagination-link' + activeClass + '" href="javascript:void(0)" data-filter="' + letter + '">' + letter + '</a>';
            filterList.appendChild(li);
        }

        // Initial render with placeholder images
        if (sortedLetters.length > 0) {
            renderBrands(sortedLetters[0]);
        }

        // Start fetching brand images immediately via GraphQL
        fetchBrandImages(null);

        // Letter filter click
        filterList.addEventListener('click', function(e) {
            var link = e.target.closest('a.pagination-link');
            if (!link) return;

            var letter = link.getAttribute('data-filter');
            var allLinks = document.querySelectorAll('.filter_list a.pagination-link, .filter_list .pagination-item');
            for (var n = 0; n < allLinks.length; n++) {
                allLinks[n].classList.remove('active');
            }
            link.classList.add('active');
            link.parentElement.classList.add('active');
            renderBrands(letter);
        });

        // === AUTOCOMPLETE ===
        var input = document.getElementById('brand_search');
        var suggestions = document.getElementById('brand_suggestions');
        var activeIndex = -1;

        function showSuggestions(matches) {
            suggestions.innerHTML = '';
            if (matches.length === 0) {
                suggestions.classList.remove('show');
                return;
            }
            for (var p = 0; p < matches.length && p < 10; p++) {
                var li = document.createElement('li');
                li.innerHTML = '<a href="' + matches[p].url + '">' + matches[p].name + '</a>';
                suggestions.appendChild(li);
            }
            suggestions.classList.add('show');
            activeIndex = -1;
        }

        input.addEventListener('input', function() {
            var val = this.value.toLowerCase();
            if (val.length < 1) {
                suggestions.classList.remove('show');
                return;
            }
            var matches = [];
            for (var q = 0; q < allBrands.length; q++) {
                if (allBrands[q].name.toLowerCase().indexOf(val) !== -1) {
                    matches.push(allBrands[q]);
                }
            }
            showSuggestions(matches);
        });

        input.addEventListener('keydown', function(e) {
            var items = suggestions.querySelectorAll('li');
            if (e.keyCode === 40) { // Down
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                for (var r = 0; r < items.length; r++) items[r].classList.remove('active');
                if (items[activeIndex]) items[activeIndex].classList.add('active');
                e.preventDefault();
            } else if (e.keyCode === 38) { // Up
                activeIndex = Math.max(activeIndex - 1, 0);
                for (var s = 0; s < items.length; s++) items[s].classList.remove('active');
                if (items[activeIndex]) items[activeIndex].classList.add('active');
                e.preventDefault();
            } else if (e.keyCode === 13 && activeIndex >= 0) { // Enter
                var activeLink = items[activeIndex] ? items[activeIndex].querySelector('a') : null;
                if (activeLink) window.location.href = activeLink.href;
                e.preventDefault();
            } else if (e.keyCode === 27) { // Escape
                suggestions.classList.remove('show');
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.brand_search')) {
                suggestions.classList.remove('show');
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBrands);
    } else {
        initBrands();
    }
})();
</script>

{{/partial}}
{{> layout/base}}
