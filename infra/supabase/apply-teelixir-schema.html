<!DOCTYPE html>
<html>
<head>
  <title>Apply Teelixir Distributor Intelligence Schema</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { color: #333; }
    .step { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 8px; }
    .step h3 { margin-top: 0; color: #2563eb; }
    button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button:hover { background: #1d4ed8; }
    textarea { width: 100%; height: 300px; font-family: monospace; font-size: 12px; }
    .success { color: #16a34a; font-weight: bold; }
    a { color: #2563eb; }
  </style>
</head>
<body>
  <h1>üçÑ Apply Teelixir Distributor Intelligence Schema</h1>
  
  <div class="step">
    <h3>Step 1: Open Supabase SQL Editor</h3>
    <p>Click the button below to open the SQL Editor for the Master Supabase project:</p>
    <a href="https://supabase.com/dashboard/project/qcvfxxsnqvdfmpbcgdni/sql/new" target="_blank">
      <button>Open SQL Editor ‚Üí</button>
    </a>
  </div>
  
  <div class="step">
    <h3>Step 2: Copy the Schema SQL</h3>
    <p>Click to copy the entire schema to your clipboard:</p>
    <button onclick="copySchema()">Copy Schema SQL</button>
    <span id="copied" style="display:none; margin-left: 10px;" class="success">‚úì Copied!</span>
    
    <details style="margin-top: 15px;">
      <summary>Preview SQL (click to expand)</summary>
      <textarea id="sql" readonly></textarea>
    </details>
  </div>
  
  <div class="step">
    <h3>Step 3: Paste and Run</h3>
    <ol>
      <li>Paste the SQL into the Supabase SQL Editor</li>
      <li>Click the green <strong>"Run"</strong> button (or press Ctrl+Enter)</li>
      <li>Wait for it to complete (should take a few seconds)</li>
    </ol>
  </div>
  
  <div class="step">
    <h3>Step 4: Verify</h3>
    <p>After running, you should see these tables in the Table Editor:</p>
    <ul>
      <li>tlx_product_groups</li>
      <li>tlx_products</li>
      <li>tlx_distributors</li>
      <li>tlx_distributor_orders</li>
      <li>tlx_order_line_items</li>
      <li>tlx_oos_notes</li>
      <li>tlx_sync_log</li>
    </ul>
    <p>And these views:</p>
    <ul>
      <li>v_tlx_distributor_overview</li>
      <li>v_tlx_monthly_trends</li>
      <li>v_tlx_product_group_performance</li>
      <li>v_tlx_oos_summary</li>
      <li>v_tlx_distributor_product_mix</li>
    </ul>
  </div>
  
  <script>
    const schema = "-- Teelixir Distributor Intelligence Schema\n-- Created: 2025-11-30\n-- Purpose: Track distributor orders, products, and OOS notes from Unleashed\n\n-- =============================================================================\n-- PRODUCT GROUPS (for grouping SKU variants like Lions Mane 50g/100g/250g)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_product_groups (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  group_code TEXT UNIQUE NOT NULL,              -- 'LIONS_MANE', 'REISHI', 'CHAGA'\n  group_name TEXT NOT NULL,                     -- 'Lions Mane Extract'\n  category TEXT,                                -- 'Mushroom Extracts', 'Blends'\n  display_order INTEGER DEFAULT 999,\n  is_active BOOLEAN DEFAULT TRUE,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- =============================================================================\n-- PRODUCTS (all Teelixir SKUs from Unleashed)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_products (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  unleashed_guid TEXT UNIQUE,\n  product_code TEXT UNIQUE NOT NULL,\n  product_name TEXT NOT NULL,\n  product_description TEXT,\n  product_group_id UUID REFERENCES tlx_product_groups(id),\n\n  -- Size/variant parsed from name\n  size_value DECIMAL(10,2),                     -- 50, 100, 250\n  size_unit TEXT,                               -- 'g', 'ml', 'capsules'\n  variant_type TEXT,                            -- 'powder', 'capsule', 'tincture'\n\n  -- Pricing\n  wholesale_price DECIMAL(10,2),\n  rrp DECIMAL(10,2),\n  cost_price DECIMAL(10,2),\n\n  -- Status\n  is_active BOOLEAN DEFAULT TRUE,\n  is_sellable BOOLEAN DEFAULT TRUE,\n  is_discontinued BOOLEAN DEFAULT FALSE,\n\n  -- Stock\n  stock_on_hand INTEGER DEFAULT 0,\n\n  -- Sync tracking\n  last_synced_at TIMESTAMPTZ,\n  metadata JSONB DEFAULT '{}',\n\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_products_code ON tlx_products(product_code);\nCREATE INDEX IF NOT EXISTS idx_tlx_products_group ON tlx_products(product_group_id);\nCREATE INDEX IF NOT EXISTS idx_tlx_products_active ON tlx_products(is_active) WHERE is_active = TRUE;\n\n-- =============================================================================\n-- DISTRIBUTORS (customers from Unleashed that are NOT B2C)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_distributors (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  unleashed_guid TEXT UNIQUE NOT NULL,\n  customer_code TEXT UNIQUE NOT NULL,\n  customer_name TEXT NOT NULL,\n\n  -- Contact\n  email TEXT,\n  phone TEXT,\n  contact_name TEXT,\n\n  -- Address\n  address_line1 TEXT,\n  address_line2 TEXT,\n  city TEXT,\n  state TEXT,\n  postcode TEXT,\n  country TEXT DEFAULT 'Australia',\n\n  -- Classification\n  region TEXT,                                   -- 'NSW', 'VIC', 'QLD', etc.\n  distributor_type TEXT,                         -- 'wholesale', 'retail_chain'\n\n  -- Denormalized metrics (updated by sync job)\n  first_order_date DATE,\n  last_order_date DATE,\n  total_orders INTEGER DEFAULT 0,\n  total_revenue DECIMAL(12,2) DEFAULT 0,\n  avg_order_value DECIMAL(10,2) DEFAULT 0,\n\n  -- Status\n  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'at_risk', 'churned', 'prospect')),\n\n  -- Sync tracking\n  last_synced_at TIMESTAMPTZ,\n  metadata JSONB DEFAULT '{}',\n\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_distributors_code ON tlx_distributors(customer_code);\nCREATE INDEX IF NOT EXISTS idx_tlx_distributors_status ON tlx_distributors(status);\nCREATE INDEX IF NOT EXISTS idx_tlx_distributors_last_order ON tlx_distributors(last_order_date DESC);\n\n-- =============================================================================\n-- DISTRIBUTOR ORDERS (sales orders from Unleashed)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_distributor_orders (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  distributor_id UUID NOT NULL REFERENCES tlx_distributors(id) ON DELETE CASCADE,\n  unleashed_order_guid TEXT UNIQUE NOT NULL,\n  order_number TEXT NOT NULL,\n\n  -- Dates\n  order_date DATE NOT NULL,\n  required_date DATE,\n  completed_date DATE,\n\n  -- Status\n  order_status TEXT NOT NULL,                   -- 'Completed', 'Parked', 'Open'\n\n  -- Financials\n  subtotal DECIMAL(12,2),\n  tax_total DECIMAL(10,2),\n  total DECIMAL(12,2),\n  currency TEXT DEFAULT 'AUD',\n\n  -- Notes (raw from Unleashed)\n  comments TEXT,\n\n  -- OOS parsing flags\n  has_oos_mention BOOLEAN DEFAULT FALSE,\n  has_discontinued_mention BOOLEAN DEFAULT FALSE,\n  parsed_notes JSONB,                           -- Structured parsing results\n\n  -- Sync tracking\n  last_synced_at TIMESTAMPTZ,\n  raw_data JSONB,\n\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n\n  UNIQUE(order_number)\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_orders_distributor ON tlx_distributor_orders(distributor_id);\nCREATE INDEX IF NOT EXISTS idx_tlx_orders_date ON tlx_distributor_orders(order_date DESC);\nCREATE INDEX IF NOT EXISTS idx_tlx_orders_status ON tlx_distributor_orders(order_status);\nCREATE INDEX IF NOT EXISTS idx_tlx_orders_oos ON tlx_distributor_orders(has_oos_mention) WHERE has_oos_mention = TRUE;\n\n-- =============================================================================\n-- ORDER LINE ITEMS\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_order_line_items (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  order_id UUID NOT NULL REFERENCES tlx_distributor_orders(id) ON DELETE CASCADE,\n  product_id UUID REFERENCES tlx_products(id),\n\n  -- Line details\n  line_number INTEGER,\n  product_code TEXT NOT NULL,\n  product_description TEXT,\n\n  -- Quantities\n  quantity_ordered DECIMAL(12,2) NOT NULL,\n  quantity_shipped DECIMAL(12,2) DEFAULT 0,\n  quantity_backordered DECIMAL(12,2) DEFAULT 0,\n\n  -- Pricing\n  unit_price DECIMAL(10,2),\n  discount_percent DECIMAL(5,2) DEFAULT 0,\n  line_total DECIMAL(12,2),\n  line_tax DECIMAL(10,2),\n\n  -- Line-level notes\n  line_comments TEXT,\n  has_oos_mention BOOLEAN DEFAULT FALSE,\n\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_lines_order ON tlx_order_line_items(order_id);\nCREATE INDEX IF NOT EXISTS idx_tlx_lines_product ON tlx_order_line_items(product_code);\nCREATE INDEX IF NOT EXISTS idx_tlx_lines_product_id ON tlx_order_line_items(product_id) WHERE product_id IS NOT NULL;\n\n-- =============================================================================\n-- OOS NOTES (parsed from order comments)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_oos_notes (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  order_id UUID REFERENCES tlx_distributor_orders(id) ON DELETE CASCADE,\n  line_item_id UUID REFERENCES tlx_order_line_items(id) ON DELETE CASCADE,\n\n  -- Note classification\n  note_type TEXT NOT NULL CHECK (note_type IN (\n    'out_of_stock',\n    'short_supply',\n    'discontinued',\n    'backordered',\n    'substituted',\n    'partial_shipment',\n    'other'\n  )),\n\n  -- Product reference\n  product_code TEXT,\n  product_id UUID REFERENCES tlx_products(id),\n\n  -- Details\n  original_text TEXT NOT NULL,\n  parsed_quantity INTEGER,\n  expected_date DATE,\n\n  -- Resolution tracking\n  is_resolved BOOLEAN DEFAULT FALSE,\n  resolved_at TIMESTAMPTZ,\n  resolution_notes TEXT,\n\n  detected_at TIMESTAMPTZ DEFAULT NOW(),\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n\n  -- Unique constraint for upsert (prevent duplicate notes per order)\n  UNIQUE(order_id, original_text)\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_oos_order ON tlx_oos_notes(order_id);\nCREATE INDEX IF NOT EXISTS idx_tlx_oos_product ON tlx_oos_notes(product_id);\nCREATE INDEX IF NOT EXISTS idx_tlx_oos_type ON tlx_oos_notes(note_type);\nCREATE INDEX IF NOT EXISTS idx_tlx_oos_unresolved ON tlx_oos_notes(is_resolved) WHERE is_resolved = FALSE;\n\n-- =============================================================================\n-- SYNC LOG (track sync operations)\n-- =============================================================================\nCREATE TABLE IF NOT EXISTS tlx_sync_log (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  sync_type TEXT NOT NULL,                      -- 'products', 'customers', 'orders', 'full'\n  status TEXT DEFAULT 'started' CHECK (status IN ('started', 'success', 'partial', 'failed')),\n\n  -- Counts\n  records_fetched INTEGER DEFAULT 0,\n  records_created INTEGER DEFAULT 0,\n  records_updated INTEGER DEFAULT 0,\n  records_skipped INTEGER DEFAULT 0,\n  records_failed INTEGER DEFAULT 0,\n\n  -- Timing\n  started_at TIMESTAMPTZ DEFAULT NOW(),\n  completed_at TIMESTAMPTZ,\n  duration_ms INTEGER,\n\n  -- Error tracking\n  error_message TEXT,\n  error_details JSONB,\n\n  -- Pagination tracking (for resume)\n  last_page_processed INTEGER,\n  total_pages INTEGER,\n  last_modified_since TIMESTAMPTZ,\n\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_tlx_sync_type ON tlx_sync_log(sync_type);\nCREATE INDEX IF NOT EXISTS idx_tlx_sync_started ON tlx_sync_log(started_at DESC);\n\n-- =============================================================================\n-- VIEWS\n-- =============================================================================\n\n-- Distributor overview with health status\nCREATE OR REPLACE VIEW v_tlx_distributor_overview AS\nSELECT\n  d.id,\n  d.customer_code,\n  d.customer_name,\n  d.email,\n  d.region,\n  d.status,\n  d.first_order_date,\n  d.last_order_date,\n  d.total_orders,\n  d.total_revenue,\n  d.avg_order_value,\n  CURRENT_DATE - d.last_order_date as days_since_order,\n  CASE\n    WHEN d.last_order_date IS NULL THEN 'prospect'\n    WHEN d.last_order_date < CURRENT_DATE - 60 THEN 'churning'\n    WHEN d.last_order_date < CURRENT_DATE - 30 THEN 'at_risk'\n    ELSE 'active'\n  END as health_status\nFROM tlx_distributors d;\n\n-- Monthly order trends by distributor\nCREATE OR REPLACE VIEW v_tlx_monthly_trends AS\nSELECT\n  d.id as distributor_id,\n  d.customer_code,\n  d.customer_name,\n  DATE_TRUNC('month', o.order_date) as month,\n  COUNT(o.id) as order_count,\n  SUM(o.total) as revenue,\n  AVG(o.total) as avg_order_value,\n  COUNT(DISTINCT li.product_code) as unique_products\nFROM tlx_distributors d\nJOIN tlx_distributor_orders o ON d.id = o.distributor_id\nLEFT JOIN tlx_order_line_items li ON o.id = li.order_id\nWHERE o.order_status IN ('Completed', 'Open')\nGROUP BY d.id, d.customer_code, d.customer_name, DATE_TRUNC('month', o.order_date)\nORDER BY month DESC;\n\n-- Product group performance\nCREATE OR REPLACE VIEW v_tlx_product_group_performance AS\nSELECT\n  pg.id as group_id,\n  pg.group_code,\n  pg.group_name,\n  pg.category,\n  COUNT(DISTINCT li.order_id) as order_count,\n  SUM(li.quantity_ordered) as total_units_sold,\n  SUM(li.line_total) as total_revenue,\n  COUNT(DISTINCT o.distributor_id) as unique_distributors,\n  AVG(li.unit_price) as avg_unit_price\nFROM tlx_product_groups pg\nJOIN tlx_products p ON pg.id = p.product_group_id\nJOIN tlx_order_line_items li ON p.product_code = li.product_code\nJOIN tlx_distributor_orders o ON li.order_id = o.id\nWHERE o.order_date >= CURRENT_DATE - INTERVAL '12 months'\nGROUP BY pg.id, pg.group_code, pg.group_name, pg.category\nORDER BY total_revenue DESC;\n\n-- OOS summary\nCREATE OR REPLACE VIEW v_tlx_oos_summary AS\nSELECT\n  oos.product_code,\n  p.product_name,\n  pg.group_name,\n  oos.note_type,\n  COUNT(*) as occurrence_count,\n  COUNT(DISTINCT oos.order_id) as affected_orders,\n  COUNT(*) FILTER (WHERE NOT oos.is_resolved) as unresolved_count,\n  MIN(oos.detected_at) as first_detected,\n  MAX(oos.detected_at) as last_detected\nFROM tlx_oos_notes oos\nLEFT JOIN tlx_products p ON oos.product_id = p.id\nLEFT JOIN tlx_product_groups pg ON p.product_group_id = pg.id\nWHERE oos.detected_at >= CURRENT_DATE - INTERVAL '90 days'\nGROUP BY oos.product_code, p.product_name, pg.group_name, oos.note_type\nORDER BY occurrence_count DESC;\n\n-- Distributor product mix (what each distributor buys)\nCREATE OR REPLACE VIEW v_tlx_distributor_product_mix AS\nSELECT\n  d.id as distributor_id,\n  d.customer_code,\n  d.customer_name,\n  pg.group_code,\n  pg.group_name,\n  SUM(li.quantity_ordered) as total_units,\n  SUM(li.line_total) as total_spend,\n  COUNT(DISTINCT o.id) as order_count\nFROM tlx_distributors d\nJOIN tlx_distributor_orders o ON d.id = o.distributor_id\nJOIN tlx_order_line_items li ON o.id = li.order_id\nLEFT JOIN tlx_products p ON li.product_code = p.product_code\nLEFT JOIN tlx_product_groups pg ON p.product_group_id = pg.id\nWHERE o.order_date >= CURRENT_DATE - INTERVAL '12 months'\nGROUP BY d.id, d.customer_code, d.customer_name, pg.group_code, pg.group_name\nORDER BY d.customer_name, total_spend DESC;\n\n-- =============================================================================\n-- FUNCTIONS\n-- =============================================================================\n\n-- Function to update distributor metrics after order sync\nCREATE OR REPLACE FUNCTION update_distributor_metrics(p_distributor_id UUID)\nRETURNS VOID\nLANGUAGE plpgsql\nAS $$\nBEGIN\n  UPDATE tlx_distributors\n  SET\n    first_order_date = (\n      SELECT MIN(order_date) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id\n    ),\n    last_order_date = (\n      SELECT MAX(order_date) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id\n    ),\n    total_orders = (\n      SELECT COUNT(*) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id\n    ),\n    total_revenue = (\n      SELECT COALESCE(SUM(total), 0) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id\n    ),\n    avg_order_value = (\n      SELECT COALESCE(AVG(total), 0) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id\n    ),\n    status = CASE\n      WHEN (SELECT MAX(order_date) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id) IS NULL THEN 'prospect'\n      WHEN (SELECT MAX(order_date) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id) < CURRENT_DATE - 60 THEN 'churned'\n      WHEN (SELECT MAX(order_date) FROM tlx_distributor_orders WHERE distributor_id = p_distributor_id) < CURRENT_DATE - 30 THEN 'at_risk'\n      ELSE 'active'\n    END,\n    updated_at = NOW()\n  WHERE id = p_distributor_id;\nEND;\n$$;\n\n-- Function to update all distributor metrics (batch)\nCREATE OR REPLACE FUNCTION update_all_distributor_metrics()\nRETURNS INTEGER\nLANGUAGE plpgsql\nAS $$\nDECLARE\n  v_count INTEGER := 0;\n  v_distributor_id UUID;\nBEGIN\n  FOR v_distributor_id IN SELECT id FROM tlx_distributors LOOP\n    PERFORM update_distributor_metrics(v_distributor_id);\n    v_count := v_count + 1;\n  END LOOP;\n  RETURN v_count;\nEND;\n$$;\n\n-- =============================================================================\n-- TRIGGERS\n-- =============================================================================\n\n-- Auto-update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER tr_tlx_products_updated_at\n  BEFORE UPDATE ON tlx_products\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER tr_tlx_distributors_updated_at\n  BEFORE UPDATE ON tlx_distributors\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER tr_tlx_orders_updated_at\n  BEFORE UPDATE ON tlx_distributor_orders\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER tr_tlx_product_groups_updated_at\n  BEFORE UPDATE ON tlx_product_groups\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\n-- =============================================================================\n-- RLS POLICIES (if needed)\n-- =============================================================================\n\n-- Enable RLS on all tables\nALTER TABLE tlx_product_groups ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_products ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_distributors ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_distributor_orders ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_order_line_items ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_oos_notes ENABLE ROW LEVEL SECURITY;\nALTER TABLE tlx_sync_log ENABLE ROW LEVEL SECURITY;\n\n-- Allow service role full access\nCREATE POLICY \"Service role full access\" ON tlx_product_groups FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_products FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_distributors FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_distributor_orders FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_order_line_items FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_oos_notes FOR ALL USING (true);\nCREATE POLICY \"Service role full access\" ON tlx_sync_log FOR ALL USING (true);\n";
    
    document.getElementById('sql').value = schema;
    
    function copySchema() {
      navigator.clipboard.writeText(schema).then(() => {
        const copied = document.getElementById('copied');
        copied.style.display = 'inline';
        setTimeout(() => copied.style.display = 'none', 2000);
      });
    }
    
    window.copySchema = copySchema;
  </script>
</body>
</html>