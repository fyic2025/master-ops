[{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 9 * * *"}]}},"id":"schedule","name":"Daily 9AM AEST","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[240,300]},{"parameters":{},"id":"manual","name":"Manual Trigger","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[240,480]},{"parameters":{"url":"https://qcvfxxsnqvdfmpbcgdni.supabase.co/rest/v1/dashboard_job_status?select=*","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdmZ4eHNucXZkZm1wYmNnZG5pIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODU2NzIyNywiZXhwIjoyMDY0MTQzMjI3fQ.JLTj1pOvZLoWUKfCV5NtctNI-lkEBhCzF7C9Axm6nf8"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdmZ4eHNucXZkZm1wYmNnZG5pIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODU2NzIyNywiZXhwIjoyMDY0MTQzMjI3fQ.JLTj1pOvZLoWUKfCV5NtctNI-lkEBhCzF7C9Axm6nf8"}]},"options":{"timeout":30000}},"id":"fetch-jobs","name":"Fetch Job Statuses","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,380]},{"parameters":{"jsCode":"// Fixed: Handle both array and single-item responses from n8n HTTP node\nconst rawData = $input.first().json;\nconst jobs = Array.isArray(rawData) ? rawData : (rawData.data || [rawData]);\n\nconst now = new Date();\nconst date = now.toLocaleDateString(\"en-AU\", {timeZone: \"Australia/Sydney\"});\n\nconst total = jobs.length;\nconst healthy = jobs.filter(j => j.status === \"healthy\").length;\nconst stale = jobs.filter(j => j.status === \"stale\").length;\nconst failed = jobs.filter(j => j.status === \"failed\").length;\nconst unknown = jobs.filter(j => j.status === \"unknown\").length;\nconst healthPct = total > 0 ? Math.round(100 * healthy / total) : 0;\n\nconst byBusiness = {};\nfor (const job of jobs) {\n  const biz = job.business || \"infrastructure\";\n  if (!byBusiness[biz]) byBusiness[biz] = {healthy: 0, total: 0, issues: []};\n  byBusiness[biz].total++;\n  if (job.status === \"healthy\") byBusiness[biz].healthy++;\n  else byBusiness[biz].issues.push(job.job_name + \" (\" + job.status + \")\");\n}\n\nlet summaryText = \"Daily Operations Summary - \" + date + \"\\n\\n\";\nsummaryText += \"Overall Health: \" + healthPct + \"% (\" + healthy + \"/\" + total + \" jobs healthy)\\n\";\nsummaryText += \"Status: \" + healthy + \" healthy | \" + stale + \" stale | \" + failed + \" failed | \" + unknown + \" unknown\\n\\n\";\n\nfor (const [biz, data] of Object.entries(byBusiness)) {\n  const bizPct = Math.round(100 * data.healthy / data.total);\n  summaryText += biz.toUpperCase() + \": \" + bizPct + \"% (\" + data.healthy + \"/\" + data.total + \")\\n\";\n  if (data.issues.length > 0) {\n    summaryText += \"  Issues: \" + data.issues.join(\", \") + \"\\n\";\n  }\n}\n\nconsole.log(summaryText);\n\nreturn [{\n  json: {\n    report_date: now.toISOString().split(\"T\")[0],\n    health_percentage: healthPct,\n    total_jobs: total,\n    healthy_jobs: healthy,\n    stale_jobs: stale,\n    failed_jobs: failed,\n    unknown_jobs: unknown,\n    by_business: byBusiness,\n    summary_text: summaryText,\n    generated_at: now.toISOString()\n  }\n}];"},"id":"compile","name":"Compile Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,380]},{"parameters":{"jsCode":"const report = $(\"Compile Summary\").first().json;\nconsole.log(\"=== Daily Operations Summary Complete ===\");\nconsole.log(report.summary_text);\n\nreturn [{json: {status: \"success\", report_date: report.report_date, health_percentage: report.health_percentage}}];"},"id":"complete","name":"Complete","type":"n8n-nodes-base.code","typeVersion":2,"position":[960,380]}]
